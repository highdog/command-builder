<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Management</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <div class="admin-header">
      <h1>User Management</h1>
      <a href="/" class="button">Back to Docs</a>
    </div>

    <!-- Add/Edit User Form -->
    <div class="admin-form">
      <h2 id="form-title">Add New User</h2>
      <form id="user-form">
        <input type="hidden" id="user-id">
        <div class="form-group">
          <label for="username">Username</label>
          <input type="text" id="username" required>
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password">
          <small>Leave blank to keep the current password when editing.</small>
        </div>
        <div class="form-group">
          <label for="role">Role</label>
          <select id="role" required>
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <button type="submit" id="save-user-btn">Save User</button>
        <button type="button" id="cancel-edit-btn" style="display: none;">Cancel Edit</button>
      </form>
    </div>

    <!-- User List -->
    <h2>Existing Users</h2>
    <ul id="user-list">
      <!-- Users will be loaded here -->
    </ul>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const userList = document.getElementById('user-list');
      const userForm = document.getElementById('user-form');
      const formTitle = document.getElementById('form-title');
      const userIdInput = document.getElementById('user-id');
      const usernameInput = document.getElementById('username');
      const passwordInput = document.getElementById('password');
      const roleInput = document.getElementById('role');
      const saveUserBtn = document.getElementById('save-user-btn');
      const cancelEditBtn = document.getElementById('cancel-edit-btn');

      const fetchUsers = async () => {
        try {
          const response = await fetch('/api/users');
          if (!response.ok) throw new Error('Failed to fetch users');
          const users = await response.json();
          renderUsers(users);
        } catch (error) {
          console.error(error);
          userList.innerHTML = '<li>Error loading users.</li>';
        }
      };

      const renderUsers = (users) => {
        userList.innerHTML = '';
        users.forEach(user => {
          const li = document.createElement('li');
          li.innerHTML = `
            <span>
              <strong>${user.username}</strong> (${user.role})
            </span>
            <div>
              <button class="edit-btn" data-id="${user.id}">Edit</button>
              <button class="delete-btn" data-id="${user.id}">Delete</button>
            </div>
          `;
          userList.appendChild(li);
        });
      };

      const resetForm = () => {
        userForm.reset();
        userIdInput.value = '';
        formTitle.textContent = 'Add New User';
        saveUserBtn.textContent = 'Save User';
        passwordInput.required = true;
        cancelEditBtn.style.display = 'none';
      };

      const fillFormForEdit = (user) => {
        userIdInput.value = user.id;
        usernameInput.value = user.username;
        roleInput.value = user.role;
        formTitle.textContent = `Editing ${user.username}`;
        saveUserBtn.textContent = 'Update User';
        passwordInput.required = false; // Not required on edit
        cancelEditBtn.style.display = 'inline-block';
      };

      userForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = userIdInput.value;
        const url = id ? `/api/users/${id}` : '/api/users';
        const method = id ? 'PUT' : 'POST';

        const body = {
          username: usernameInput.value,
          password: passwordInput.value,
          role: roleInput.value,
        };
        // Don't send an empty password on update
        if (id && !body.password) {
          delete body.password;
        }

        try {
          const response = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
          });
          if (!response.ok) {
            const err = await response.json();
            throw new Error(err.message || 'Failed to save user');
          }
          resetForm();
          fetchUsers();
        } catch (error) {
          alert(`Error: ${error.message}`);
        }
      });

      userList.addEventListener('click', async (e) => {
        const target = e.target;
        const id = target.dataset.id;

        if (target.classList.contains('delete-btn')) {
          if (confirm('Are you sure you want to delete this user?')) {
            try {
              const response = await fetch(`/api/users/${id}`, { method: 'DELETE' });
              if (!response.ok) {
                const err = await response.json();
                throw new Error(err.message || 'Failed to delete user');
              }
              fetchUsers();
            } catch (error) {
              alert(`Error: ${error.message}`);
            }
          }
        }

        if (target.classList.contains('edit-btn')) {
          try {
            const response = await fetch('/api/users');
            const users = await response.json();
            const userToEdit = users.find(u => u.id == id);
            if (userToEdit) {
              fillFormForEdit(userToEdit);
              window.scrollTo(0, 0);
            }
          } catch (error) {
            alert('Could not fetch user details for editing.');
          }
        }
      });
      
      cancelEditBtn.addEventListener('click', resetForm);

      // Initial load
      fetchUsers();
    });
  </script>
</body>
</html>