<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试API中文数据</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-section {
            margin: 1rem 0;
            padding: 1rem;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        
        .data-display {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
            margin: 0.5rem 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .doc-display {
            background: #fafafa;
            padding: 1rem;
            border-radius: 4px;
            margin: 0.5rem 0;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin: 0.25rem;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .lang-panel {
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>测试API中文数据</h1>
        
        <div class="test-section">
            <h3>控制面板</h3>
            <button onclick="testLogin()">1. 测试登录</button>
            <button onclick="testAPI()">2. 测试API访问</button>
            <button onclick="testSpecificCommand()">3. 测试特定命令</button>
            <button onclick="testLanguageSwitch()">4. 测试语言切换</button>
            <button onclick="clearResults()">清除结果</button>
        </div>
        
        <div id="results"></div>
        
        <div class="comparison" id="comparison" style="display: none;">
            <div class="lang-panel">
                <h4>中文版本</h4>
                <div id="zh-display" class="doc-display"></div>
            </div>
            <div class="lang-panel">
                <h4>英文版本</h4>
                <div id="en-display" class="doc-display"></div>
            </div>
        </div>
    </div>

    <script>
        const resultsDiv = document.getElementById('results');
        const comparisonDiv = document.getElementById('comparison');
        const zhDisplayDiv = document.getElementById('zh-display');
        const enDisplayDiv = document.getElementById('en-display');
        
        let currentCommand = null;
        
        function addResult(message, type = 'info', data = null) {
            const div = document.createElement('div');
            div.className = `test-section ${type}`;
            div.innerHTML = message;
            
            if (data) {
                const dataDiv = document.createElement('div');
                dataDiv.className = 'data-display';
                dataDiv.textContent = JSON.stringify(data, null, 2);
                div.appendChild(dataDiv);
            }
            
            resultsDiv.appendChild(div);
            div.scrollIntoView({ behavior: 'smooth' });
        }
        
        function clearResults() {
            resultsDiv.innerHTML = '';
            comparisonDiv.style.display = 'none';
        }
        
        async function testLogin() {
            addResult('正在测试登录...', 'info');
            
            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'username=admin&password=admin'
                });
                
                if (response.ok) {
                    addResult('✓ 登录成功！', 'success');
                } else {
                    addResult(`✗ 登录失败: ${response.status} ${response.statusText}`, 'error');
                }
                
            } catch (error) {
                addResult(`✗ 登录错误: ${error.message}`, 'error');
            }
        }
        
        async function testAPI() {
            addResult('正在测试API访问...', 'info');
            
            try {
                const response = await fetch('/api/commands');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                const totalCommands = Object.values(data).reduce((sum, cmds) => sum + cmds.length, 0);
                
                addResult(`✓ API访问成功！找到 ${totalCommands} 个命令`, 'success');
                
                // Show sample data
                const firstCategory = Object.keys(data)[0];
                if (firstCategory && data[firstCategory].length > 0) {
                    const sampleCommand = data[firstCategory][0];
                    addResult('示例命令数据:', 'info', {
                        id: sampleCommand.id,
                        hex_id: sampleCommand.hex_id,
                        name: sampleCommand.name,
                        category: firstCategory
                    });
                }
                
            } catch (error) {
                addResult(`✗ API访问失败: ${error.message}`, 'error');
            }
        }
        
        async function testSpecificCommand() {
            addResult('正在测试特定命令 (0x07)...', 'info');
            
            try {
                // First get the command ID for 0x07
                const listResponse = await fetch('/api/commands');
                if (!listResponse.ok) {
                    throw new Error('无法获取命令列表');
                }
                
                const allCommands = await listResponse.json();
                let targetCommand = null;
                
                // Find command with hex_id 0x07
                for (const [category, commands] of Object.entries(allCommands)) {
                    const found = commands.find(cmd => cmd.hex_id === '0x07');
                    if (found) {
                        targetCommand = found;
                        break;
                    }
                }
                
                if (!targetCommand) {
                    throw new Error('未找到 0x07 命令');
                }
                
                addResult(`✓ 找到命令: ${targetCommand.name} (ID: ${targetCommand.id})`, 'success');
                
                // Get detailed command data
                const detailResponse = await fetch(`/api/commands/${targetCommand.id}`);
                if (!detailResponse.ok) {
                    throw new Error(`获取命令详情失败: ${detailResponse.status}`);
                }
                
                currentCommand = await detailResponse.json();
                
                addResult('✓ 命令详情获取成功', 'success');
                
                // Check Chinese data
                const hasZhName = !!currentCommand.name_zh;
                const hasZhDesc = !!currentCommand.description_zh;
                const zhDescLength = currentCommand.description_zh ? currentCommand.description_zh.length : 0;
                
                addResult(`中文数据检查:`, 'info');
                addResult(`- 中文名称: ${hasZhName ? '✓' : '✗'} "${currentCommand.name_zh || 'N/A'}"`, hasZhName ? 'success' : 'error');
                addResult(`- 中文描述: ${hasZhDesc ? '✓' : '✗'} (${zhDescLength} 字符)`, hasZhDesc ? 'success' : 'error');
                
                if (hasZhDesc) {
                    const preview = currentCommand.description_zh.substring(0, 100);
                    addResult(`中文描述预览: "${preview}..."`, 'info');
                }
                
                // Show comparison
                if (hasZhName && hasZhDesc) {
                    showComparison(currentCommand);
                }
                
            } catch (error) {
                addResult(`✗ 测试失败: ${error.message}`, 'error');
            }
        }
        
        function showComparison(command) {
            comparisonDiv.style.display = 'grid';
            
            // Display Chinese version
            if (command.description_zh) {
                zhDisplayDiv.innerHTML = marked.parse(command.description_zh);
            } else {
                zhDisplayDiv.innerHTML = '<p style="color: red;">中文描述不可用</p>';
            }
            
            // Display English version
            if (command.description_en) {
                enDisplayDiv.innerHTML = marked.parse(command.description_en);
            } else {
                enDisplayDiv.innerHTML = '<p style="color: red;">英文描述不可用</p>';
            }
            
            addResult('✓ 中英文对比显示已更新，请查看下方对比面板', 'success');
        }
        
        async function testLanguageSwitch() {
            if (!currentCommand) {
                addResult('⚠️ 请先运行"测试特定命令"', 'error');
                return;
            }
            
            addResult('正在测试语言切换逻辑...', 'info');
            
            // Test Chinese display
            const zhResult = displayCommandDocumentation(currentCommand, 'zh');
            addResult(`中文显示测试: ${zhResult.success ? '✓' : '✗'} ${zhResult.message}`, zhResult.success ? 'success' : 'error');
            
            // Test English display
            const enResult = displayCommandDocumentation(currentCommand, 'en');
            addResult(`英文显示测试: ${enResult.success ? '✓' : '✗'} ${enResult.message}`, enResult.success ? 'success' : 'error');
            
            addResult('✓ 语言切换逻辑测试完成', 'success');
        }
        
        function displayCommandDocumentation(command, lang) {
            let description = '';
            let success = false;
            let message = '';
            
            if (lang === 'zh' && command.description_zh) {
                description = command.description_zh;
                success = true;
                message = `使用中文描述 (${description.length} 字符)`;
            } else if (lang === 'en' && command.description_en) {
                description = command.description_en;
                success = true;
                message = `使用英文描述 (${description.length} 字符)`;
            } else {
                description = command.description_zh || command.description_en || '暂无说明。';
                success = false;
                message = `回退到备用描述 (${lang} 版本不可用)`;
            }
            
            return { success, message, description };
        }
        
        // Auto-run initial test
        document.addEventListener('DOMContentLoaded', () => {
            addResult('页面加载完成，请按顺序点击测试按钮', 'info');
        });
    </script>
</body>
</html>
