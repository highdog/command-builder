<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>蓝牙命令构建器</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Using styles from the main style.css, but adding specific layout rules */
        .main-layout { display: flex; gap: 2rem; align-items: flex-start; padding: 2rem; }
        .left-panel { flex: 1; background-color: #f8f9fa; padding: 1.5rem; border-radius: 8px; border: 1px solid #e9ecef; }
        .right-panel { flex: 2; position: sticky; top: 2rem; }
        .doc-content { background-color: #fff; padding: 1.5rem; border-radius: 8px; border: 1px solid #e9ecef; max-height: 85vh; overflow-y: auto; }
        .doc-placeholder { color: #6c757d; text-align: center; padding: 3rem 0; }
        .editable-desc { border: 1px dashed #007bff; padding: 10px; min-height: 150px; margin-top: 10px; background-color: #f8f9fa; }
        .doc-action-btn { margin-left: 10px; }
        .lang-switcher { float: right; }
        #payload-columns-container { margin-top: 2rem; }
    </style>
</head>
<body>

  <header class="global-header">
    <div class="header-left">
      <div class="header-title">
        <h1>蓝牙命令构建器</h1>
      </div>
    </div>
    <div class="header-controls">
      <a href="/">Command Builder</a>
      <a href="/documentation">Documentation</a>
      <a href="/admin" id="ui-admin-link" style="display: none;">Admin</a>
    </div>
  </header>

  <div class="main-layout">
    <!-- Left Panel: Builder -->
    <div class="left-panel">
        <h2>命令构建</h2>
        <div class="form-group">
            <label for="protocol-select">选择协议:</label>
            <select id="protocol-select">
                <option value="gatt">GATT over BLE</option>
                <option value="rfcomm">RFCOMM</option>
            </select>
        </div>
        <div class="form-group">
            <label for="command-select">选择命令:</label>
            <select id="command-select">
                <option value="">-- 请先登录 --</option>
            </select>
        </div>
        <div id="payload-columns-container">
            <!-- Payload fields will be generated here -->
        </div>
    </div>

    <!-- Right Panel: Documentation -->
    <div class="right-panel">
        <div id="command-display-container" class="doc-content">
            <p class="doc-placeholder">请在左侧选择一个命令以查看其说明。</p>
        </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- STATE ---
        let currentUser = null;
        let currentCommand = null;
        let editMode = false;
        let currentLanguage = 'zh';

        // --- UI ELEMENTS ---
        const adminLink = document.getElementById('ui-admin-link');
        const commandSelect = document.getElementById('command-select');
        const docContainer = document.getElementById('command-display-container');

        // --- FUNCTIONS ---

        const checkSession = async () => {
            try {
                const response = await fetch('/api/session');
                const data = await response.json();
                if (data.loggedIn) {
                    currentUser = data.user;
                    if (currentUser.role === 'admin') {
                        adminLink.style.display = 'inline-block';
                    }
                } else {
                    // If not logged in, redirect to login page
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('Session check failed:', error);
                // Also redirect if the API call fails
                window.location.href = '/login';
            }
        };

        const populateCommands = async () => {
            try {
                const response = await fetch('/api/commands');
                if (!response.ok) throw new Error('Failed to fetch commands');
                const commandsByCat = await response.json();
                
                commandSelect.innerHTML = '<option value="">-- 请选择一个命令 --</option>';
                for (const category in commandsByCat) {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = category;
                    commandsByCat[category].forEach(command => {
                        const option = document.createElement('option');
                        option.value = command.id;
                        option.textContent = command.name;
                        optgroup.appendChild(option);
                    });
                    commandSelect.appendChild(optgroup);
                }
            } catch (error) {
                console.error(error);
                commandSelect.innerHTML = '<option value="">-- 加载失败 --</option>';
            }
        };

        const fetchCommandDetails = async (commandId) => {
            if (!commandId) {
                docContainer.innerHTML = '<p class="doc-placeholder">请在左侧选择一个命令以查看其说明。</p>';
                currentCommand = null;
                return;
            }
            try {
                const response = await fetch(`/api/commands/${commandId}`);
                if (!response.ok) throw new Error('Failed to fetch command details');
                currentCommand = await response.json();
                renderDocumentation();
            } catch (error) {
                console.error(error);
                docContainer.innerHTML = '<p class="doc-placeholder" style="color: red;">无法加载命令详情。</p>';
            }
        };

        const renderDocumentation = () => {
            if (!currentCommand) return;

            let headerControls = '';
            if (currentUser?.role === 'admin') {
                if (editMode) {
                    headerControls = `
                        <button id="save-btn" class="button">保存</button>
                        <button id="cancel-btn" class="button">取消</button>
                    `;
                } else {
                    headerControls = `<button id="edit-btn" class="button">编辑</button>`;
                }
            }

            let body = '';
            if (editMode) {
                body = `
                    <h3>编辑英文文档</h3>
                    <div id="desc-en-editor" class="editable-desc" contenteditable="true">${currentCommand.description_en || ''}</div>
                    <hr style="margin: 2rem 0;">
                    <h3>编辑中文文档</h3>
                    <div id="desc-zh-editor" class="editable-desc" contenteditable="true">${currentCommand.description_zh || ''}</div>
                `;
            } else {
                const desc = (currentLanguage === 'zh') 
                    ? (currentCommand.description_zh || '暂无中文说明。') 
                    : (currentCommand.description_en || 'No English description available.');
                body = marked.parse(desc);
            }

            const langSwitch = `<button id="lang-switch-btn" class="button lang-switcher">${currentLanguage === 'zh' ? 'Switch to English' : '切换到中文'}</button>`;
            const title = (currentLanguage === 'zh') ? currentCommand.name_zh : currentCommand.name_en;

            docContainer.innerHTML = `
                <div style="overflow: auto;">
                    ${editMode ? '' : langSwitch}
                    ${headerControls}
                </div>
                <h2 style="clear: both;">${title}</h2>
                <div>${body}</div>
            `;
        };
        
        const updateDescription = async (lang, description) => {
            // Placeholder for the actual update logic
            console.log(`Saving ${lang} description for command ${currentCommand.id}: ${description}`);
            // In a real scenario, you would have a fetch call here:
            // await fetch(`/api/commands/${currentCommand.id}/description`, { ... });
        };

        // --- EVENT LISTENERS ---
        commandSelect.addEventListener('change', (e) => fetchCommandDetails(e.target.value));

        docContainer.addEventListener('click', async (e) => {
            if (e.target.id === 'edit-btn') {
                editMode = true;
                renderDocumentation();
            }
            if (e.target.id === 'cancel-btn') {
                editMode = false;
                renderDocumentation();
            }
            if (e.target.id === 'lang-switch-btn') {
                currentLanguage = (currentLanguage === 'zh') ? 'en' : 'zh';
                renderDocumentation();
            }
            if (e.target.id === 'save-btn') {
                const descEn = document.getElementById('desc-en-editor').innerHTML;
                const descZh = document.getElementById('desc-zh-editor').innerHTML;
                
                // Here you would call the API to save the data
                await updateDescription('en', descEn);
                await updateDescription('zh', descZh);

                alert('保存成功！（占位符）');
                
                // Refresh local data and exit edit mode
                currentCommand.description_en = descEn;
                currentCommand.description_zh = descZh;
                editMode = false;
                renderDocumentation();
            }
        });

        // --- INITIALIZATION ---
        const init = async () => {
            await checkSession();
            // Only populate commands if the user is logged in (which checkSession ensures)
            populateCommands();
        };

        init();
    });
  </script>
</body>
</html>