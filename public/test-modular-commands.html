<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试模块化命令系统</title>
    <link rel="stylesheet" href="/style.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
        }
        .command-test {
            border: 1px solid #ddd;
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
        }
        .command-test h3 {
            margin-top: 0;
            color: #333;
        }
        .test-output {
            background: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            font-family: monospace;
        }
        .status {
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.loading { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>模块化命令系统测试</h1>
        <p>这个页面用于测试新的模块化命令处理器系统。</p>
        
        <div id="loading-status" class="status loading">正在加载命令系统...</div>
        
        <div id="test-results"></div>
        
        <div class="command-test">
            <h3>命令测试区域</h3>
            <label for="command-select">选择命令:</label>
            <select id="command-select">
                <option value="">-- 请选择命令 --</option>
                <option value="0x00">0x00 - Device Type</option>
                <option value="0x02">0x02 - Serial Number</option>
                <option value="0x03">0x03 - Feature Version</option>
                <option value="0x06">0x06 - Battery Status</option>
                <option value="0x07">0x07 - Bluetooth LED Config</option>
                <option value="0x09">0x09 - LE Configurations</option>
                <option value="0x14">0x14 - Firmware Version</option>
                <option value="0x15">0x15 - Earbuds Color & Status</option>
                <option value="0x16">0x16 - Set Earbuds Color</option>
                <option value="0x17">0x17 - Peripheral Status</option>
                <option value="0x19">0x19 - MAC Address</option>
                <option value="0x20">0x20 - Usage Statistics</option>
                <option value="0x21">0x21 - Reset Statistics</option>
                <option value="0x30">0x30 - ANC Mode</option>
                <option value="0x31">0x31 - Transparency Mode</option>
                <option value="0x32">0x32 - Gaming Mode</option>
                <option value="0x33">0x33 - Multipoint Mode</option>
                <option value="0x34">0x34 - Auto Power Off</option>
                <option value="0x35">0x35 - Sound Enhancement</option>
                <option value="0x36">0x36 - Equalizer Settings</option>
                <option value="0x37">0x37 - Get ANC On Mode</option>
                <option value="0x38">0x38 - Set ANC On Mode</option>
                <option value="0x41">0x41 - Usage Time</option>
                <option value="0x44">0x44 - Get Equalizer Mode</option>
                <option value="0x45">0x45 - Set Equalizer Mode</option>
                <option value="0x46">0x46 - Get User EQ Configuration</option>
                <option value="0x47">0x47 - Set User EQ Configuration</option>
                <option value="0x48">0x48 - Trigger Media Button</option>
                <option value="0x49">0x49 - Play Status</option>
                <option value="0x4a">0x4A - Get Device Name</option>
                <option value="0x4b">0x4B - Set Device Name</option>
                <option value="0x4c">0x4C - Get Auto Shutdown Time</option>
                <option value="0x4d">0x4D - Set Auto Shutdown Time</option>
                <option value="0x4e">0x4E - Get Voice Assistant Mode</option>
                <option value="0x4f">0x4F - Set Voice Assistant Mode</option>
                <option value="0x57">0x57 - Get Voice Prompts Volume</option>
                <option value="0x58">0x58 - Set Voice Prompts Volume</option>
                <option value="0x59">0x59 - Button Mapping</option>
                <option value="0x5a">0x5A - Set Custom Keys</option>
                <option value="0x5b">0x5B - Get Prompt Language</option>
                <option value="0x5c">0x5C - Set Prompt Language</option>
                <option value="0x5d">0x5D - Factory Reset</option>
                <option value="0x5e">0x5E - Get Prompt Sound State</option>
                <option value="0x5f">0x5F - Set Prompt Sound State</option>
                <option value="0x60">0x60 - Get ANC Mode</option>
                <option value="0x61">0x61 - Set ANC Mode</option>
                <option value="0x62">0x62 - Get Low Latency Mode</option>
                <option value="0x63">0x63 - Set Low Latency Mode</option>
                <option value="0x64">0x64 - Get Wearing Detection</option>
                <option value="0x65">0x65 - Set Wearing Detection</option>
                <option value="0x66">0x66 - Get Enabled Voice Prompts</option>
                <option value="0x67">0x67 - Set Enabled Voice Prompts</option>
                <option value="0x68">0x68 - Get LED Brightness</option>
                <option value="0x69">0x69 - Set LED Brightness</option>
                <option value="0x70">0x70 - Get Sidetone Mode</option>
                <option value="0x71">0x71 - Set Sidetone Mode</option>
                <option value="0x72">0x72 - Get Sidetone Gain</option>
                <option value="0x73">0x73 - Set Sidetone Gain</option>
                <option value="0x7c">0x7C - Get Dolby Atmos Config</option>
            </select>
            
            <div id="command-container" style="margin-top: 20px;"></div>
            
            <div id="output-section" style="margin-top: 20px; display: none;">
                <h4>输出:</h4>
                <div class="test-output" id="command-output"></div>
            </div>
        </div>
    </div>

    <!-- Load the modular command system -->
    <script src="js/commands/base-command.js"></script>
    <script src="js/command-loader.js"></script>
    
    <script>
        let generateOutput;
        let currentCommandInstance = null;
        
        document.addEventListener('DOMContentLoaded', async () => {
            const loadingStatus = document.getElementById('loading-status');
            const testResults = document.getElementById('test-results');
            const commandSelect = document.getElementById('command-select');
            const commandContainer = document.getElementById('command-container');
            const outputSection = document.getElementById('output-section');
            const commandOutput = document.getElementById('command-output');
            
            // Define generateOutput function
            generateOutput = () => {
                if (currentCommandInstance) {
                    try {
                        const payload = currentCommandInstance.getPayload();
                        const packetType = currentCommandInstance.getPacketType();
                        
                        const output = {
                            commandId: currentCommandInstance.commandId,
                            packetType: packetType,
                            payload: payload,
                            payloadHex: payload.map(b => '0x' + b.toString(16).padStart(2, '0')).join(' ')
                        };
                        
                        commandOutput.textContent = JSON.stringify(output, null, 2);
                        outputSection.style.display = 'block';
                    } catch (error) {
                        commandOutput.textContent = 'Error: ' + error.message;
                        outputSection.style.display = 'block';
                    }
                }
            };
            
            // Test command loading
            const testCommands = async () => {
                // Use the command list from CommandLoader
                const availableCommands = CommandLoader.AVAILABLE_COMMANDS;
                const results = [];
                
                for (const commandId of availableCommands) {
                    try {
                        const command = await commandLoader.loadCommand(commandId);
                        results.push({
                            commandId,
                            status: 'success',
                            message: `Successfully loaded ${commandId}`,
                            command: command
                        });
                    } catch (error) {
                        results.push({
                            commandId,
                            status: 'error',
                            message: `Failed to load ${commandId}: ${error.message}`,
                            error: error
                        });
                    }
                }
                
                return results;
            };
            
            // Display test results
            const displayResults = (results) => {
                testResults.innerHTML = '<h2>加载测试结果:</h2>';
                
                results.forEach(result => {
                    const div = document.createElement('div');
                    div.className = `status ${result.status}`;
                    div.textContent = result.message;
                    testResults.appendChild(div);
                });
                
                const successCount = results.filter(r => r.status === 'success').length;
                const totalCount = results.length;
                
                const summary = document.createElement('div');
                summary.className = 'status ' + (successCount === totalCount ? 'success' : 'error');
                summary.textContent = `总结: ${successCount}/${totalCount} 个命令加载成功`;
                testResults.appendChild(summary);
            };
            
            // Handle command selection
            commandSelect.addEventListener('change', async (e) => {
                const commandId = e.target.value;
                if (!commandId) {
                    commandContainer.innerHTML = '';
                    outputSection.style.display = 'none';
                    currentCommandInstance = null;
                    return;
                }
                
                try {
                    currentCommandInstance = commandLoader.getCommand(commandId);
                    if (currentCommandInstance) {
                        currentCommandInstance.render(commandContainer);
                        generateOutput();
                    } else {
                        commandContainer.innerHTML = '<p class="status error">命令未加载</p>';
                    }
                } catch (error) {
                    commandContainer.innerHTML = `<p class="status error">渲染错误: ${error.message}</p>`;
                }
            });
            
            // Initialize
            try {
                loadingStatus.textContent = '正在测试命令加载...';
                const results = await testCommands();
                displayResults(results);
                loadingStatus.style.display = 'none';
            } catch (error) {
                loadingStatus.className = 'status error';
                loadingStatus.textContent = '初始化失败: ' + error.message;
            }
        });
    </script>
</body>
</html>
